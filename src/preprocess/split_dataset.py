import argparse
import pandas as pd
import random
from pathlib import Path

def main():
    parser = argparse.ArgumentParser(description="Split dataset into train, val, and test.")
    parser.add_argument("--index-csv", required=True, help="Path to sequences.csv generated by prepare_mars.py")
    parser.add_argument("--output-csv", required=True, help="Path to save the new CSV with splits")
    parser.add_argument("--train-ratio", type=float, default=0.7, help="Ratio of IDs for training")
    parser.add_argument("--val-ratio", type=float, default=0.1, help="Ratio of IDs for validation")
    parser.add_argument("--test-ratio", type=float, default=0.2, help="Ratio of IDs for testing")
    parser.add_argument("--use-standard-split", action="store_true", help="Only split train into train/val")
    parser.add_argument("--seed", type=int, default=42, help="Random seed for reproducibility")
    
    args = parser.parse_args()
    
    # Normalize ratios if they don't sum to 1
    total = args.train_ratio + args.val_ratio + args.test_ratio
    train_r = args.train_ratio / total
    val_r = args.val_ratio / total
    
    random.seed(args.seed)
    
    df = pd.read_csv(args.index_csv)
    
    # Standardize column names
    rename_dict = {}
    if 'person_global_id' in df.columns:
        rename_dict['person_global_id'] = 'person_id'
    if 'rgb_dir' in df.columns:
        rename_dict['rgb_dir'] = 'frames_dir'
    if rename_dict:
        df = df.rename(columns=rename_dict)

    seq_ids = sorted(df['sequence_id'].unique().tolist())
    random.shuffle(seq_ids)
    num_total = len(seq_ids)

    if args.use_standard_split and 'split' in df.columns:
        orig_train_seqs = sorted(df[df['split'] == 'train']['sequence_id'].unique().tolist())
        random.shuffle(orig_train_seqs)
        
        num_val = int(len(orig_train_seqs) * args.val_ratio / (args.train_ratio + args.val_ratio))
        
        val_seqs = set(orig_train_seqs[:num_val])
        train_seqs = set(orig_train_seqs[num_val:])
        
        df.loc[df['sequence_id'].isin(val_seqs) & (df['split'] == 'train'), 'split'] = 'val'
        print(f"Standard MARS Protocol: Split original train into {len(train_seqs)} train and {len(val_seqs)} validation sequences.")
    else:
        num_train = int(num_total * train_r)
        num_val = int(num_total * val_r)
        
        train_seqs = set(seq_ids[:num_train])
        val_seqs = set(seq_ids[num_train:num_train+num_val])
        test_seqs = set(seq_ids[num_train+num_val:])
        
        df.loc[df['sequence_id'].isin(train_seqs), 'split'] = 'train'
        df.loc[df['sequence_id'].isin(val_seqs), 'split'] = 'val'
        df.loc[df['sequence_id'].isin(test_seqs), 'split'] = 'test'
        
        print(f"Custom Split (Sequences): Train: {len(train_seqs)}, Val: {len(val_seqs)}, Test: {len(test_seqs)} sequences.")

    df.to_csv(args.output_csv, index=False)
    print(f"Saved split metadata to {args.output_csv}")

if __name__ == "__main__":
    main()
